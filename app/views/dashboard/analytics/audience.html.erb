<div class="row">
  <%= render 'dashboard/sidebar' %>
  <div class="page-admin">
    <h2>Audience Insights</h2>
    <% unless @posts.empty? %>
      <p>
        MTGCast tracks every download of each episode and analyzes them to provide high-level audience data, like a general location and device type. We then break them down into three categories: <em>Individual</em>, <em>Aggregate</em>, and <em>Total</em>.
      </p>
      <p>
        <em>Individual</em> represents the downloads from <%= link_to 'your unique RSS feed', page_feed_path(@page) %> as well as the plays initiated from each episode's embedded audio player. <em>Aggregate</em> represents the downloads from MTGCast's aggregate feed, while <em>Total</em> combines the <em>Individual</em> and <em>Aggregate</em> counts.
      </p>
      <br />
      <%= form_tag page_dashboard_analytics_audience_path(@page), method: :get do %>
        <div style="display:flex; align-items:end;">
          <div class="col-md-3" style="margin-left:-15px;">
            <%= label_tag :start_date, 'Start Date', class: 'control-label' %>
            <%= date_field_tag :start_date, params[:start_date] || Time.zone.today - 7.days, class: 'form-control', disabled: !current_user&.admin? %>
          </div>
          <div class="col-md-3">
            <%= label_tag :end_date, 'End Date', class: 'control-label' %>
            <%= date_field_tag :end_date, params[:end_date] || Time.zone.today, class: 'form-control', disabled: !current_user&.admin? %>
          </div>
          <div class="col-md-3">
            <%= label_tag :feed, 'Feed', class: 'control-label' %>
            <%= select_tag :feed, options_for_select([ ['Individual', 'individual'], ['Aggregate', 'aggregate_feed'], 'Both' ], params[:feed] || 'Both'), class: 'form-control', disabled: !current_user&.admin? %>
          </div>
          <div class="col-md-3">
            <%= submit_tag 'Filter', class: 'btn btn-light', disabled: !current_user&.admin? %>
          </div>
        </div>
      <% end %>
      <br />
      <h4>Total Downloads</h4>
      <p>
        All downloads of all episode of your podcast.
      </p>
      <%= column_chart downloads_page_dashboard_graphs_path(@page, start_date: params[:start_date], end_date: params[:end_date], feed: params[:feed]) %>
      <br />
      <br />
      <hr>
      <br />
      <br />
      <div style="display:flex;">
        <div class="col-lg-6">
          <h4>Episodes</h4>
          <p>
            Your top episodes by total downloads.
          </p>
          <%= bar_chart episodes_page_dashboard_graphs_path(@page, start_date: params[:start_date], end_date: params[:end_date], feed: params[:feed]), xtitle: "Downloads" %>
        </div>
        <div class="col-lg-6">
          <h4>Listening Devices</h4>
          <p>
            Your audience's most used listening devices (by total downloads). A listening device can range from a phone to a desktop web browser.
          </p>
          <%= bar_chart devices_page_dashboard_graphs_path(@page, start_date: params[:start_date], end_date: params[:end_date], feed: params[:feed]), xtitle: "Downloads" %>
        </div>
      </div>
      <br />
      <br />
      <hr>
      <br />
      <br />
      <div style="display:flex;">
        <div class="col-lg-4">
          <h4>Platforms</h4>
          <p>
            The most common platforms where your episodes received downloads.
          </p>
          <%= bar_chart platforms_page_dashboard_graphs_path(@page, start_date: params[:start_date], end_date: params[:end_date], feed: params[:feed]), xtitle: "Downloads" %>
        </div>
        <div class="col-lg-4">
          <h4>Top Referrers</h4>
          <p>
            The sites that referred downloads of your podcast.
          </p>
          <%= bar_chart referrers_page_dashboard_graphs_path(@page, start_date: params[:start_date], end_date: params[:end_date], feed: params[:feed]), xtitle: "Downloads" %>
        </div>
        <div class="col-lg-4">
          <h4>Top Countries</h4>
          <p>
            The top countries where your your audience listened from.
          </p>
          <%= bar_chart countries_page_dashboard_graphs_path(@page, start_date: params[:start_date], end_date: params[:end_date], feed: params[:feed]), xtitle: "Downloads" %>
        </div>
      </div>
    <% else %>
      <p>
        <strong>You haven't uploaded any episodes.</strong>
      </p>
    <% end %>
    <div class="pagination-container">
      <%= will_paginate @posts %>
    </div>
    <% if @page.created_at < "2019-02-01"%>
      <p>
        <em>
          Note: Episodes from 2018 and earlier may show the incorrect publish date due to an MTGCast server error. Also, episodes published before mid-September 2019 will not include download count information while episodes before mid-February 2020 will not have accurate individual/aggregate feed download splits.
        </em>
      </p>
    <% elsif @page.created_at < "2019-10-01"%>
      <p>
        <em>
          Note: Episodes published before mid-September 2019 will not include download count information while episodes before mid-February 2020 will not have accurate individual/aggregate feed download splits.
        </em>
      </p>
    <% elsif @page.created_at < "2020-03-01"%>
      <p>
        <em>
          Note: Episodes published before mid-February 2020 will not have accurate individual/aggregate feed download splits.
        </em>
      </p>
    <% end %>
  </div>
</div>
