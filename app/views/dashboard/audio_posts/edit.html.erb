<% content_for :head do %>
  <%#= javascript_pack_tag 'uppy' %>
<% end %>

<div class="content">
  <h2>Edit Episode</h2>
  <div class="admin-post-container">
    <%= form_with model: @post, url: page_dashboard_audio_post_path(@page, @post), method: 'put' do |form| %>
      <%= form.hidden_field :postable_type, value: @post.postable_type %>
      <%= form.fields_for(:postable) do |postable_form| %>
        <div class="form-group required">
          <%= postable_form.label :title, 'Title', class: 'control-label' %>
          <%= postable_form.text_field :title, required: true, class: 'form-control edit-post-title', value: @post.postable.title %>
          <div class="slug-container">
            <span><%= link_to "#{page_post_url(@page, @post)}", page_post_path(@page, @post) %></span>
          </div>
        </div>
        <div>
          <% if @post.postable.podcast_episode %>
            <audio id="player" controls>
              <source src="<%= @post.postable.podcast_episode&.url %>" type="<%= @post.postable.podcast_episode.file.metadata.dig('mime_type') %>">
            </audio>
            <p id="filename">
              <em>
                <%= URI.unescape(@post.postable.podcast_episode.file.metadata['filename']) %>
                <% unless @post.postable.podcast_episode.file.data['storage'] == 'external' %>
                  <span id="remove-audio"><%= render 'shared/icons/file_x', color: 'delete', size: '1.5rem' %></span>
                <% else %>
                  (Externally hosted)
                <% end %>
              </em>
            </p>
            <div id="audio">
            </div>
            <div class="file-input-container" style="display: none;">
              <%= form.hidden_field 'attachment[label]', required: true, value: 'podcast_episode' %>
              <%= form.hidden_field 'attachment[file]', class: 'upload-hidden', required: true %>
              <%= form.file_field 'attachment[file]', class: 'upload-file', accept: 'audio/mp3,audio/*;capture=microphone', style: 'display: none;' %>
            </div>
          <% else %>
            <p id="no-audio-warning">
              <%= render 'shared/icons/exclamation_circle', color: 'red', size: '1.5rem' %>
              <em><strong>This episode has no audio file attached.</strong></em>
            </p>
            <div id="audio">
            </div>
            <div class="file-input-container">
              <%= form.hidden_field 'attachment[label]', required: true, value: 'podcast_episode' %>
              <%= form.hidden_field 'attachment[file]', class: 'upload-hidden', required: true %>
              <%= form.file_field 'attachment[file]', class: 'upload-file', accept: 'audio/mp3,audio/*;capture=microphone', style: 'display: none;' %>
            </div>
          <% end %>
        </div>
        <div class="form-group required">
          <%= postable_form.hidden_field :id, value: @post.postable.id %>
          <%= postable_form.rich_text_area :content, class: 'full-height' %>
        </div>
        <div class="form-group required">
          <%= form.label :publish_time, 'Publish Time', class: 'control-label' %> <em><span id="timezone"></span></em>
          <br />
          <%= form.select :publish_time_month, options_for_select([['01–Jan', 'January'], ['02–Feb', 'February'], ['03–Mar', 'March'], ['04–Apr', 'April'], ['05–May', 'May'], ['06–Jun', 'June'], ['07–Jul', 'July'], ['08–Aug', 'August'], ['09–Sep', 'September'], ['10–Oct', 'October'], ['11–Nov', 'November'], ['12–Dec', 'December']]), {}, { class: 'form-control publish-time month' } %>
          <%= form.text_field :publish_time_day, min: 1, max: 31, required: true, class: 'form-control publish-time day' %>,
          <%= form.text_field :publish_time_year, min: 1, required: true, class: 'form-control publish-time year' %> at
          <%= form.text_field :publish_time_hour, min: 0, max: 24, required: true, class: 'form-control publish-time hour' %> :
          <%= form.text_field :publish_time_minute, min: 1, max: 59, required: true, class: 'form-control publish-time minute' %>
          <%= form.hidden_field :publish_time_zone, value: nil %>
        </div>
      <% end %>
      <div class="actions">
        <%= form.submit 'Save', class: 'btn btn-primary', id: 'post-save' %>
        <%= link_to 'Delete Post', page_dashboard_audio_post_path(@page, @post), class: 'btn btn-danger btn-delete',  method: "delete", data: { confirm: "Are you sure you want to delete this post?" } %>
      </div>
    <% end %>
  </div>
</div>

<script>
  function removeAudio() {
    var player = document.getElementById('player'),
        filename = document.getElementById('filename'),
        fileInputContainer = document.querySelector('.file-input-container');

    $(player).hide();
    $(filename).hide();
    $(fileInputContainer).show();
  }

  $(document).on('ready turbolinks:load', function() {
    $(document.getElementById('remove-audio')).on("click", removeAudio);

    var date = new Date('<%= @post.publish_time.utc.iso8601 %>'),
        month = date.toLocaleString('default', { month: 'long' }),
        day = String(date.getDate()).padStart(2, '0'),
        year = date.getFullYear(),
        hour = String(date.getHours()).padStart(2, '0'),
        minute = String(date.getMinutes()).padStart(2, '0'),
        zone = date.getTimezoneOffset() / 60;

    $('select[name="post[publish_time_month]"]').val(month);
    $('input[name="post[publish_time_day]"]').val(day);
    $('input[name="post[publish_time_year]"]').val(year);
    $('input[name="post[publish_time_hour]"]').val(hour);
    $('input[name="post[publish_time_minute]"]').val(minute);
    $('input[name="post[publish_time_zone]"]').val(zone);
  })
</script>
